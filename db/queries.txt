
# Top ISBNs by sheer mentions
SELECT isbn, count(url) as Mentions
FROM comments
GROUP BY isbn
ORDER BY Mentions DESC
LIMIT 25;

# ISBNs that have no metadata
SELECT DISTINCT product_id
FROM comments c
WHERE NOT EXISTS (
    SELECT 1
    FROM products p
    WHERE c.product_id = p.id
);


# Filters down comments to the top 3 scored comments on a per book/author basis
# this is to prevent spam, where an author keeps mentioning the same book over and over
SELECT rank_filter.isbn FROM (
    SELECT comments.*,
        ROW_NUMBER() OVER (
            PARTITION BY author, isbn
            ORDER BY score DESC
        )
    FROM comments
) rank_filter
WHERE rank_filter.row_number <= 3;


# Retrieves top books based on the number of mentions, with the spam protection as mentioned above
SELECT isbn, COUNT(isbn) AS Mentions
FROM (
    SELECT rank_filter.isbn FROM (
        SELECT comments.*,
            ROW_NUMBER() OVER (
                PARTITION BY author, isbn
                ORDER BY score DESC
            )
        FROM comments
    ) rank_filter
    WHERE rank_filter.row_number <= 3
) comments_filter
GROUP BY isbn
ORDER BY Mentions DESC

